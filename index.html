<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ…¢ç›ˆOYå‹•æ…‹åœæè¨ˆç®—å™¨ï¼ˆæ…¢ç›ˆBUFFERç‰ˆ - å…¨åˆç´„æ”¯æ´ï¼‰</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1200px; margin: 40px auto; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .main-container { display: flex; gap: 16px; }
        .calculator { flex: 1; background: rgba(255,255,255,0.1); padding: 18px; border-radius: 16px; backdrop-filter: blur(10px); box-shadow: 0 6px 24px rgba(0,0,0,0.3); }
        .sidebar { flex: 0 0 320px; background: rgba(0,255,136,0.1); padding: 16px; border-radius: 16px; border-left: 4px solid #00ff88; }
        h1 { text-align: center; margin-bottom: 14px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5); font-size: 22px; }
        h2 { color: #00ff88; margin-top: 0; font-size: 17px; }
        .input-group { display: flex; align-items: center; margin: 5px 0; gap: 4px; }
        .input-group label { min-width: 80px; font-size: 13px; }
        input, select { padding: 6px; border: none; border-radius: 6px; font-size: 13px; background: rgba(255,255,255,0.9); width: 100px; }
        button { background: linear-gradient(45deg, #ff6b6b, #feca57); border: none; padding: 8px 16px; border-radius: 10px; color: white; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 10px 0; width: 100%; }
        button:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
        .result { background: rgba(0,255,136,0.3); padding: 14px; border-radius: 12px; margin-top: 10px; border-left: 4px solid #00ff88; }
        .stop-price { font-size: 22px; font-weight: bold; color: #00ff88; background: rgba(0,255,136,0.3); padding: 6px; border-radius: 8px; display: inline-block; }
        .risk-table { background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px; margin: 6px 0; overflow-x: auto; }
        .risk-table table { width: 100%; border-collapse: collapse; color: white; font-size: 12px; }
        .risk-table th, .risk-table td { padding: 4px; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .risk-table th { text-align: left; }
        .formula { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; font-family: monospace; font-size: 11px; }
        .buffer-table { background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px; margin: 6px 0; font-size: 12px; }
        .buffer-table table { width: 100%; border-collapse: collapse; }
        .buffer-table th { background: rgba(0,255,136,0.3); padding: 6px; text-align: left; }
        .buffer-table td { padding: 4px 6px; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .buffer-recommend { background: #ffeb3b; color: #333; padding: 6px; border-radius: 6px; font-weight: bold; text-align: center; margin: 6px 0; font-size: 12px; }
        .sidebar-tip { background: rgba(255,255,255,0.1); padding: 6px; border-radius: 6px; margin: 4px 0; font-size: 12px; }

        /* ä¸‰æ’ç·Šæ¹ŠæŒ‰éˆ•ç¾¤çµ„ï¼šæ¯é¡†ç´„ä½” 1/4 è¡Œå¯¬ */
        .choice-group { display: flex; gap: 2px; flex-wrap: wrap; }
        .choice-btn {
            padding: 3px 6px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.4);
            background: rgba(0,0,0,0.2);
            color: #fff;
            cursor: pointer;
            font-size: 11px;
            line-height: 1.1;
            white-space: nowrap;
            flex: 0 0 24%;
        }
        .choice-btn.active {
            background: #00ff88;
            color: #222;
            border-color: #00ff88;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- å·¦é‚Šè¨ˆç®—å™¨ -->
        <div class="calculator">
            <h1>ğŸ¯ æ…¢ç›ˆæ•¸æ“šæ•™è‚² OY å‹•æ…‹åœæè¨ˆç®—å™¨</h1>
            
            <div class="input-group">
                <label>åˆç´„:</label>
                <select id="contract" onchange="updatePointValue()">
                    <option value="MES">MES ($5/é»)</option>
                    <option value="ES">ES ($50/é»)</option>
                    <option value="MNQ">MNQ ($2/é»)</option>
                    <option value="NQ">NQ ($20/é»)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>ç¾åƒ¹:</label>
                <input type="number" id="price" value="66" step="0.25">
            </div>
            
            <div class="input-group">
                <label>ATR (é»):</label>
                <input type="number" id="atr" value="6.0" step="0.1">
            </div>
            
            <!-- å–®ç­† R å€¼ï¼šä¸‰æ’æŒ‰éˆ• -->
            <div class="input-group">
                <label>R å€¼ ($):</label>
                <div id="risk_group" class="choice-group">
                    <button type="button" class="choice-btn" onclick="setRisk(100, this)">100</button>
                    <button type="button" class="choice-btn" onclick="setRisk(150, this)">150</button>
                    <button type="button" class="choice-btn active" onclick="setRisk(200, this)">200</button>
                    <button type="button" class="choice-btn" onclick="setRisk(250, this)">250</button>
                    <button type="button" class="choice-btn" onclick="setRisk(300, this)">300</button>
                    <button type="button" class="choice-btn" onclick="setRisk(350, this)">350</button>
                    <button type="button" class="choice-btn" onclick="setRisk(400, this)">400</button>
                    <button type="button" class="choice-btn" onclick="setRisk(450, this)">450</button>
                    <button type="button" class="choice-btn" onclick="setRisk(500, this)">500</button>
                    <button type="button" class="choice-btn" onclick="setRisk(550, this)">550</button>
                    <button type="button" class="choice-btn" onclick="setRisk(600, this)">600</button>
                    <button type="button" class="choice-btn" onclick="setRisk(650, this)">650</button>
                </div>
                <input type="hidden" id="risk_dollar" value="200">
            </div>
            
            <!-- GEX å€é–“ï¼šæŒ‰éˆ• -->
            <div class="input-group">
                <label>GEX å€é–“:</label>
                <div id="gex_zone_group" class="choice-group">
                    <button type="button" class="choice-btn active" data-value="pos" onclick="setGexZone('pos', this)">æ­£GEX</button>
                    <button type="button" class="choice-btn" data-value="trans" onclick="setGexZone('trans', this)">Transition</button>
                    <button type="button" class="choice-btn" data-value="neg" onclick="setGexZone('neg', this)">è² GEX</button>
                </div>
                <input type="hidden" id="gex_zone" value="pos">
            </div>
            
            <!-- äº¤æ˜“é¡å‹ï¼šæŒ‰éˆ• -->
            <div class="input-group">
                <label>äº¤æ˜“é¡å‹:</label>
                <div id="trade_type_group" class="choice-group">
                    <button type="button" class="choice-btn active" data-value="revert" onclick="setTradeType('revert', this)">åè½‰</button>
                    <button type="button" class="choice-btn" data-value="breakout" onclick="setTradeType('breakout', this)">çªç ´</button>
                </div>
                <input type="hidden" id="trade_type" value="revert">
            </div>
            
            <!-- æ–¹å‘ï¼šæŒ‰éˆ• -->
            <div class="input-group">
                <label>æ–¹å‘:</label>
                <div id="direction_group" class="choice-group">
                    <button type="button" class="choice-btn active" data-value="long" onclick="setDirection('long', this)">å¤š</button>
                    <button type="button" class="choice-btn" data-value="short" onclick="setDirection('short', this)">ç©º</button>
                </div>
                <input type="hidden" id="direction" value="long">
            </div>
            
            <!-- Bufferï¼šä¸‰æ’æŒ‰éˆ• -->
            <div class="input-group">
                <label>Buffer:</label>
                <div id="buffer_group" class="choice-group">
                    <button type="button" class="choice-btn" onclick="setBuffer(0, this)">-3</button>
                    <button type="button" class="choice-btn" onclick="setBuffer(0, this)">-2</button>
                    <button type="button" class="choice-btn" onclick="setBuffer(0, this)">-1</button>
                    <button type="button" class="choice-btn" onclick="setBuffer(0, this)">0</button>
                    <button type="button" class="choice-btn" onclick="setBuffer(1, this)">1</button>
                    <button type="button" class="choice-btn active" onclick="setBuffer(2, this)">2</button>
                    <button type="button" class="choice-btn" onclick="setBuffer(3, this)">3</button>
                    <button type="button" class="choice-btn" onclick="setBuffer(4, this)">4</button>
                    <button type="button" class="choice-btn" onclick="setBuffer(5, this)">5</button>
                    <button type="button" class="choice-btn" onclick="setBuffer(6, this)">6</button>
                </div>
                <input type="hidden" id="buffer" value="2">
            </div>
            
            <button onclick="calculateSL()">ğŸš€ è¨ˆç®—åœæ & å€‰ä½</button>
            
            <div id="result" class="result" style="display: none;">
                <h3 style="margin-top:0;font-size:15px;">ğŸ“Š ç²¾æº–é¢¨æ§çµæœ</h3>
                <div id="result-content"></div>
                <div id="risk-table" class="risk-table"></div>
                <div id="formula" class="formula"></div>
            </div>
        </div>
        
        <!-- å³é‚Šæ™ºæ…§å»ºè­°å€ -->
        <div class="sidebar">
            <h2>ğŸ’¡ BUFFER æ…¢ç›ˆå»ºè­°</h2>
            
            <div class="buffer-recommend" id="buffer-recommend">
                è¼¸å…¥åƒæ•¸å¾Œå³æ™‚å»ºè­°...
            </div>
            
            <div class="buffer-table">
                <table>
                    <tr><th>ğŸ“… å¸‚å ´ç‹€æ³</th><th>å»ºè­° Buffer</th></tr>
                    <tr><td>æ­£å¸¸äº¤æ˜“æ—¥</td><td><strong>0-2 é»</strong></td></tr>
                    <tr><td>FOMC/ER/OPEX/æ•¸æ“šå…¬å¸ƒ</td><td><strong>3-5 é»</strong></td></tr>
                    <tr><td>é–‹ç›¤æ™‚æ®µ</td><td><strong>2-4 é»</strong></td></tr>
                    <tr><td>GEXé—œéµä½</td><td><strong>1-3 é»</strong></td></tr>
                    <tr><td>æœˆå­£æœ«å‘¨äº”/é«˜æ³¢æ—¥</td><td><strong>4-6 é»</strong></td></tr>
                </table>
            </div>
            
            <div class="sidebar-tip">
                ğŸ’¡ <strong>å¿«é€Ÿè¦å‰‡ï¼š</strong><br>
                â€¢ å‘¨ä¸€ï½å‘¨å››ï¼š<strong>Buffer=2</strong><br>
                â€¢ æœˆå­£æœ«å‘¨äº”/é–‹ç›¤æ™‚æ®µ/OPEX/é«˜æ³¢æ—¥ï¼š<strong>Buffer=4</strong><br>
                â€¢ FOMC/é‡å¤§æ•¸æ“šäº‹ä»¶ï¼š<strong>Buffer=6</strong>
            </div>
            
            <div class="sidebar-tip">
                ğŸ¯ <strong>å…¨åˆç´„æ”¯æ´ï¼š</strong><br>
                MES($5) â€¢ ES($50) â€¢ <strong>MNQ($2)</strong> â€¢ <strong>NQ($20)</strong><br>
                <em>NQç´æŒ‡é«˜æ³¢å‹•æ›´éœ€ç²¾æº–é¢¨æ§ï¼</em>
            </div>
        </div>
    </div>

    <script>
        let pointValue = 5; // MES é è¨­

        function updatePointValue() {
            const contract = document.getElementById('contract').value;
            if (contract === 'MES') pointValue = 5;
            else if (contract === 'ES') pointValue = 50;
            else if (contract === 'MNQ') pointValue = 2;
            else if (contract === 'NQ') pointValue = 20;
            updateBufferRecommendation();
        }

        function setActiveButton(groupId, btn) {
            const group = document.getElementById(groupId);
            if (!group) return;
            Array.from(group.querySelectorAll('.choice-btn')).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setRisk(value, btn) {
            document.getElementById('risk_dollar').value = value;
            setActiveButton('risk_group', btn);
        }

        function setGexZone(value, btn) {
            document.getElementById('gex_zone').value = value;
            setActiveButton('gex_zone_group', btn);
            updateBufferRecommendation();
        }

        function setTradeType(value, btn) {
            document.getElementById('trade_type').value = value;
            setActiveButton('trade_type_group', btn);
            updateBufferRecommendation();
        }

        function setDirection(value, btn) {
            document.getElementById('direction').value = value;
            setActiveButton('direction_group', btn);
        }

        function setBuffer(value, btn) {
            document.getElementById('buffer').value = value;
            setActiveButton('buffer_group', btn);
            updateBufferRecommendation();
        }

        function updateBufferRecommendation() {
            const atr = parseFloat(document.getElementById('atr').value) || 12;
            const gexZone = document.getElementById('gex_zone').value;
            
            let recommendation = 'å»ºè­°ï¼š';
            if (gexZone === 'pos') recommendation += ' <strong>1-2é»</strong> (æ­£GEXç©©å®š)';
            else if (gexZone === 'neg') recommendation += ' <strong>3-5é»</strong> (è² GEXé«˜æ³¢)';
            else recommendation += ' <strong>2-4é»</strong> (Transitionä¸ç¢ºå®š)';
            
            recommendation += ` | å‹•æ…‹ï¼š0.25Ã—ATR(${Math.round(atr*0.25*10)/10}é»)`;
            document.getElementById('buffer-recommend').innerHTML = recommendation;
        }

        function calculateSL() {
            const price = parseFloat(document.getElementById('price').value);
            const atr = parseFloat(document.getElementById('atr').value);
            const riskDollar = parseFloat(document.getElementById('risk_dollar').value);
            const gexZone = document.getElementById('gex_zone').value;
            const tradeType = document.getElementById('trade_type').value;
            const direction = document.getElementById('direction').value;
            const contract = document.getElementById('contract').value;
            const buffer = parseFloat(document.getElementById('buffer').value) || 0;

            const zoneMultipliers = { pos: 0.8, trans: 1.2, neg: 2.0 };
            const riskMultipliers = {
                revert: { pos: 0.8, trans: 1.0, neg: 1.2 },
                breakout: { pos: 1.0, trans: 1.2, neg: 1.5 }
            };

            const kRisk = riskMultipliers[tradeType][gexZone];
            const slDistance = Math.round((kRisk * atr + buffer) * 10) / 10;

            const contracts = Math.max(1, Math.floor(riskDollar / (slDistance * pointValue)));
            const actualRisk = contracts * slDistance * pointValue;
            const perContractRisk = slDistance * pointValue;
            const slPrice = direction === 'short' ? price + slDistance : price - slDistance;

            document.getElementById('result-content').innerHTML = `
                <p><strong>åœæè·é›¢:</strong> <span style="color: #00ff88; font-size: 18px;">${slDistance} é»</span></p>
                <p><strong>ç¢ºåˆ‡åœæåƒ¹:</strong> <span class="stop-price">${slPrice.toFixed(1)}</span></p>
                <p><strong>å»ºè­°å€‰ä½:</strong> <span style="color: #00ff88; font-size: 18px;">${contracts} ${contract} åˆç´„</span></p>
            `;

            document.getElementById('risk-table').innerHTML = `
                <table>
                    <tr><th>é¢¨éšªé …ç›®</th><th>é‡‘é¡ ($)</th></tr>
                    <tr><td>ä½ çš„ R å€¼è¨­å®š</td><td><strong>${riskDollar}</strong></td></tr>
                    <tr><td>å¯¦éš›ç¸½é¢¨éšª</td><td style="color: ${actualRisk <= riskDollar ? '#00ff88' : '#ff6b6b'}">${actualRisk.toFixed(0)}</td></tr>
                    <tr><td>æ¯åˆç´„é¢¨éšª</td><td>$${perContractRisk.toFixed(0)} (${contract})</td></tr>
                </table>
            `;

            document.getElementById('formula').innerHTML = `
                ğŸ’¡ å…¬å¼: ${kRisk.toFixed(1)} Ã— ATR(${atr}) + Buffer(${buffer}) = ${slDistance}é»<br>
                ğŸ“ ç¢ºåˆ‡åœæ = é€²å ´åƒ¹ ${direction === 'short' ? '+' : '-' } ${slDistance}é» = ${slPrice.toFixed(1)}<br>
                ğŸ’° å€‰ä½: ${riskDollar} Ã· (${slDistance} Ã— $${pointValue}) = ${contracts}åˆç´„<br>
                ğŸ¯ ${gexZone.toUpperCase()} å€é–“ï¼Œ${tradeType} ${direction} ç­–ç•¥
            `;

            document.getElementById('result').style.display = 'block';
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }

        document.addEventListener('input', updateBufferRecommendation);
        document.addEventListener('change', updateBufferRecommendation);
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') calculateSL();
        });

        updatePointValue();
        updateBufferRecommendation();
    </script>
</body>
</html>
