<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GEX å‹•æ…‹åœæè¨ˆç®—å™¨ï¼ˆæ…¢ç›ˆBUFFERç‰ˆï¼‰</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .main-container { display: flex; gap: 30px; }
        .calculator { flex: 1; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .sidebar { flex: 0 0 350px; background: rgba(0,255,136,0.1); padding: 25px; border-radius: 20px; border-left: 5px solid #00ff88; }
        h1 { text-align: center; margin-bottom: 30px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        h2 { color: #00ff88; margin-top: 0; }
        .input-group { display: flex; align-items: center; margin: 15px 0; gap: 10px; }
        input, select { padding: 12px; border: none; border-radius: 10px; font-size: 16px; background: rgba(255,255,255,0.9); width: 120px; }
        button { background: linear-gradient(45deg, #ff6b6b, #feca57); border: none; padding: 15px 30px; border-radius: 10px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin: 20px 0; width: 100%; }
        button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .result { background: rgba(0,255,136,0.3); padding: 25px; border-radius: 15px; margin-top: 20px; border-left: 5px solid #00ff88; }
        .stop-price { font-size: 28px; font-weight: bold; color: #00ff88; background: rgba(0,255,136,0.3); padding: 10px; border-radius: 10px; display: inline-block; }
        .risk-table { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin: 10px 0; overflow-x: auto; }
        .risk-table table { width: 100%; border-collapse: collapse; color: white; }
        .risk-table th, .risk-table td { padding: 8px; text-align: right; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .risk-table th { text-align: left; }
        .warning { background: rgba(255,107,107,0.3); padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ff6b6b; }
        .formula { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; font-family: monospace; font-size: 14px; }
        .buffer-table { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin: 10px 0; }
        .buffer-table table { width: 100%; border-collapse: collapse; }
        .buffer-table th { background: rgba(0,255,136,0.3); padding: 10px; text-align: left; }
        .buffer-table td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .buffer-recommend { background: #ffeb3b; color: #333; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; margin: 10px 0; }
        .sidebar-tip { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 14px; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- å·¦é‚Šè¨ˆç®—å™¨ -->
        <div class="calculator">
            <h1>ğŸ¯ GEX å‹•æ…‹åœæè¨ˆç®—å™¨</h1>
            
            <div class="input-group">
                <label>åˆç´„:</label>
                <select id="contract" onchange="updatePointValue()">
                    <option value="MES">MES ($5/é»)</option>
                    <option value="ES">ES ($50/é»)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>ç¾åƒ¹:</label>
                <input type="number" id="price" value="5025" step="0.25">
            </div>
            
            <div class="input-group">
                <label>ATR (é»):</label>
                <input type="number" id="atr" value="12" step="0.1">
            </div>
            
            <div class="input-group">
                <label>å–®ç­† R å€¼ ($):</label>
                <input type="number" id="risk_dollar" value="625" step="25">
            </div>
            
            <div class="input-group">
                <label>GEX å€é–“:</label>
                <select id="gex_zone">
                    <option value="pos">æ­£GEXæ ¸å¿ƒ</option>
                    <option value="trans">Transition/0GEX</option>
                    <option value="neg">è² GEX</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>äº¤æ˜“é¡å‹:</label>
                <select id="trade_type">
                    <option value="revert">åè½‰äº¤æ˜“</option>
                    <option value="breakout">çªç ´äº¤æ˜“</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>æ–¹å‘:</label>
                <select id="direction">
                    <option value="long" selected>åšå¤š</option>
                    <option value="short">åšç©º</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Buffer (é»):</label>
                <input type="number" id="buffer" value="3" step="0.1">
            </div>
            
            <button onclick="calculateSL()">ğŸš€ è¨ˆç®—åœæ & å€‰ä½</button>
            
            <div id="result" class="result" style="display: none;">
                <h3>ğŸ“Š ç²¾æº–é¢¨æ§çµæœ</h3>
                <div id="result-content"></div>
                <div id="risk-table" class="risk-table"></div>
                <div id="formula" class="formula"></div>
            </div>
        </div>
        
        <!-- å³é‚Šæ™ºæ…§å»ºè­°å€ -->
        <div class="sidebar">
            <h2>ğŸ’¡ BUFFER æ…¢ç›ˆå»ºè­°</h2>
            
            <div class="buffer-recommend" id="buffer-recommend">
                è¼¸å…¥åƒæ•¸å¾Œå³æ™‚å»ºè­°...
            </div>
            
            <div class="buffer-table">
                <table>
                    <tr><th>ğŸ“… å¸‚å ´ç‹€æ³</th><th>å»ºè­° Buffer</th></tr>
                    <tr><td>æ­£å¸¸äº¤æ˜“æ—¥</td><td><strong>0-2 é»</strong></td></tr>
                    <tr><td>FOMC/ER/OPEX/æ•¸æ“šå…¬å¸ƒ</td><td><strong>3-5 é»</strong></td></tr>
                    <tr><td>é–‹ç›¤æ™‚æ®µ</td><td><strong>2-4 é»</strong></td></tr>
                    <tr><td>GEXé—œéµä½</td><td><strong>1-3 é»</strong></td></tr>
                    <tr><td>æœˆå­£æœ«å‘¨äº”/é«˜æ³¢æ—¥</td><td><strong>4-6 é»</strong></td></tr>
                </table>
            </div>
            
            <div class="sidebar-tip">
                ğŸ’¡ <strong>å¿«é€Ÿè¦å‰‡ï¼š</strong><br>
                â€¢ å‘¨ä¸€ï½å‘¨å››ï¼š<strong>Buffer=2</strong><br>
                â€¢ æœˆå­£æœ«å‘¨äº”/é–‹ç›¤æ™‚æ®µ/OPEX/é«˜æ³¢æ—¥ï¼š<strong>Buffer=4</strong><br>
                â€¢ FOMC/é‡å¤§æ•¸æ“šäº‹ä»¶ï¼š<strong>Buffer=6</strong>
            </div>
            
            <div class="sidebar-tip">
                ğŸ¯ <strong>Buffer ä½œç”¨ï¼š</strong><br>
                åœæè·é›¢ = GEXå…¬å¼ + Buffer<br>
                <em>å¤š3é» = å¤š3é»å®‰å…¨ç©ºé–“ï¼</em>
            </div>
        </div>
    </div>

    <script>
        let pointValue = 5; // MES é è¨­

        function updatePointValue() {
            const contract = document.getElementById('contract').value;
            pointValue = contract === 'MES' ? 5 : 50;
            updateBufferRecommendation();
        }

        function updateBufferRecommendation() {
            const atr = parseFloat(document.getElementById('atr').value) || 12;
            const gexZone = document.getElementById('gex_zone').value;
            const tradeType = document.getElementById('trade_type').value;
            
            let recommendation = 'å»ºè­°ï¼š';
            if (gexZone === 'pos') recommendation += ' <strong>1-2é»</strong> (æ­£GEXç©©å®š)';
            else if (gexZone === 'neg') recommendation += ' <strong>3-5é»</strong> (è² GEXé«˜æ³¢)';
            else recommendation += ' <strong>2-4é»</strong> (Transitionä¸ç¢ºå®š)';
            
            recommendation += ` | å‹•æ…‹ï¼š0.25Ã—ATR(${Math.round(atr*0.25*10)/10}é»)`;
            
            document.getElementById('buffer-recommend').innerHTML = recommendation;
        }

        function calculateSL() {
            const price = parseFloat(document.getElementById('price').value);
            const atr = parseFloat(document.getElementById('atr').value);
            const riskDollar = parseFloat(document.getElementById('risk_dollar').value);
            const gexZone = document.getElementById('gex_zone').value;
            const tradeType = document.getElementById('trade_type').value;
            const direction = document.getElementById('direction').value;
            const contract = document.getElementById('contract').value;
            const buffer = parseFloat(document.getElementById('buffer').value) || 0;

            // GEX å€é–“å¯¬åº¦ (ATRå€æ•¸)
            const zoneMultipliers = { pos: 0.8, trans: 1.2, neg: 2.0 };
            // åœæå€æ•¸
            const riskMultipliers = {
                revert: { pos: 0.8, trans: 1.0, neg: 1.2 },
                breakout: { pos: 1.0, trans: 1.2, neg: 1.5 }
            };

            const zoneWidth = zoneMultipliers[gexZone] * atr;
            const kRisk = riskMultipliers[tradeType][gexZone];
            const slDistance = Math.round((kRisk * atr + buffer) * 10) / 10;

            // ç²¾æº–å€‰ä½è¨ˆç®—
            const contracts = Math.max(1, Math.floor(riskDollar / (slDistance * pointValue)));
            const actualRisk = contracts * slDistance * pointValue;
            const perContractRisk = slDistance * pointValue;

            // ã€ä¿®æ”¹ã€‘ç¢ºåˆ‡åœæåƒ¹ = é€²å ´åƒ¹ Â± åœæè·é›¢
            const slPrice = direction === 'short' ? price + slDistance : price - slDistance;

            // é¡¯ç¤ºçµæœ
            document.getElementById('result-content').innerHTML = `
                <p><strong>åœæè·é›¢:</strong> <span style="color: #00ff88; font-size: 24px;">${slDistance} é»</span></p>
                <p><strong>ç¢ºåˆ‡åœæåƒ¹:</strong> <span class="stop-price">${slPrice.toFixed(1)}</span></p>
                <p><strong>å»ºè­°å€‰ä½:</strong> <span style="color: #00ff88; font-size: 24px;">${contracts} ${contract} åˆç´„</span></p>
            `;

            document.getElementById('risk-table').innerHTML = `
                <table>
                    <tr><th>é¢¨éšªé …ç›®</th><th>é‡‘é¡ ($)</th></tr>
                    <tr><td>ä½ çš„ R å€¼è¨­å®š</td><td><strong>${riskDollar}</strong></td></tr>
                    <tr><td>å¯¦éš›ç¸½é¢¨éšª</td><td style="color: ${actualRisk <= riskDollar ? '#00ff88' : '#ff6b6b'}">${actualRisk.toFixed(0)}</td></tr>
                    <tr><td>æ¯åˆç´„é¢¨éšª</td><td>${perContractRisk.toFixed(0)}</td></tr>
                </table>
            `;

            document.getElementById('formula').innerHTML = `
                ğŸ’¡ å…¬å¼: ${kRisk.toFixed(1)} Ã— ATR(${atr}) + Buffer(${buffer}) = ${slDistance}é»<br>
                ğŸ“ ç¢ºåˆ‡åœæ = é€²å ´åƒ¹ ${direction === 'short' ? '+' : '-'} ${slDistance}é» = ${slPrice.toFixed(1)}<br>
                ğŸ’° å€‰ä½: ${riskDollar} Ã· (${slDistance} Ã— $${pointValue}) = ${contracts}åˆç´„<br>
                ğŸ¯ ${gexZone.toUpperCase()} å€é–“ï¼Œ${tradeType} ${direction} ç­–ç•¥
            `;

            document.getElementById('result').style.display = 'block';
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }

        // å³æ™‚æ›´æ–°å»ºè­° + Enteréµ
        document.addEventListener('input', updateBufferRecommendation);
        document.addEventListener('change', updateBufferRecommendation);
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') calculateSL();
        });

        // åˆå§‹åŒ–
        updatePointValue();
        updateBufferRecommendation();
    </script>
</body>
</html>
